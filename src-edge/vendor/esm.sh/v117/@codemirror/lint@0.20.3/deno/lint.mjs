/* esm.sh - esbuild bundle(@codemirror/lint@0.20.3) deno production */
import{Decoration as g,showPanel as Y,EditorView as v,ViewPlugin as Z,hoverTooltip as K,logException as U,gutter as X,showTooltip as J,getPanel as Q,WidgetType as W,GutterMarker as ee}from"/v117/@codemirror/view@0.20.7/deno/view.mjs";import{StateEffect as k,StateField as L,Facet as E,combineConfig as B,RangeSet as O}from"/v117/@codemirror/state@0.20.1/deno/state.mjs";import u from"/v117/crelt@1.0.5/deno/crelt.mjs";var R=class{constructor(e,o,i){this.from=e,this.to=o,this.diagnostic=i}},m=class{constructor(e,o,i){this.diagnostics=e,this.panel=o,this.selected=i}static init(e,o,i){let n=e,s=i.facet(h).markerFilter;s&&(n=s(n));let r=g.set(n.map(l=>l.from==l.to||l.from==l.to-1&&i.doc.lineAt(l.from).to==l.from?g.widget({widget:new A(l),diagnostic:l}).range(l.from):g.mark({attributes:{class:"cm-lintRange cm-lintRange-"+l.severity},diagnostic:l}).range(l.from,l.to)),!0);return new m(r,o,b(r))}};function b(t,e=null,o=0){let i=null;return t.between(o,1e9,(n,s,{spec:r})=>{if(!(e&&r.diagnostic!=e))return i=new R(n,s,r.diagnostic),!1}),i}function j(t,e){return!!(t.effects.some(o=>o.is(C))||t.changes.touchesRange(e.pos))}function G(t,e){return t.field(d,!1)?e:e.concat(k.appendConfig.of([d,v.decorations.compute([d],o=>{let{selected:i,panel:n}=o.field(d);return!i||!n||i.from==i.to?g.none:g.set([ie.range(i.from,i.to)])}),K(oe,{hideOn:j}),le]))}function te(t,e){return{effects:G(t,[C.of(e)])}}var C=k.define(),F=k.define(),$=k.define(),d=L.define({create(){return new m(g.none,null,null)},update(t,e){if(e.docChanged){let o=t.diagnostics.map(e.changes),i=null;if(t.selected){let n=e.changes.mapPos(t.selected.from,1);i=b(o,t.selected.diagnostic,n)||b(o,null,n)}t=new m(o,t.panel,i)}for(let o of e.effects)o.is(C)?t=m.init(o.value,t.panel,e.state):o.is(F)?t=new m(t.diagnostics,o.value?w.open:null,t.selected):o.is($)&&(t=new m(t.diagnostics,t.panel,o.value));return t},provide:t=>[Y.from(t,e=>e.panel),v.decorations.from(t,e=>e.diagnostics)]});function ge(t){let e=t.field(d,!1);return e?e.diagnostics.size:0}var ie=g.mark({class:"cm-lintRange cm-lintRange-active"});function oe(t,e,o){let{diagnostics:i}=t.state.field(d),n=[],s=2e8,r=0;i.between(e-(o<0?1:0),e+(o>0?1:0),(a,c,{spec:f})=>{e>=a&&e<=c&&(a==c||(e>a||o>0)&&(e<c||o<0))&&(n.push(f.diagnostic),s=Math.min(a,s),r=Math.max(c,r))});let l=t.state.facet(h).tooltipFilter;return l&&(n=l(n)),n.length?{pos:s,end:r,above:t.state.doc.lineAt(s).to<r,create(){return{dom:H(t,n)}}}:null}function H(t,e){return u("ul",{class:"cm-tooltip-lint"},e.map(o=>_(t,o,!1)))}var ne=t=>{let e=t.state.field(d,!1);(!e||!e.panel)&&t.dispatch({effects:G(t.state,[F.of(!0)])});let o=Q(t,w.open);return o&&o.dom.querySelector(".cm-panel-lint ul").focus(),!0},I=t=>{let e=t.state.field(d,!1);return!e||!e.panel?!1:(t.dispatch({effects:F.of(!1)}),!0)},se=t=>{let e=t.state.field(d,!1);if(!e)return!1;let o=t.state.selection.main,i=e.diagnostics.iter(o.to+1);return!i.value&&(i=e.diagnostics.iter(0),!i.value||i.from==o.from&&i.to==o.to)?!1:(t.dispatch({selection:{anchor:i.from,head:i.to},scrollIntoView:!0}),!0)},pe=[{key:"Mod-Shift-m",run:ne},{key:"F8",run:se}],N=Z.fromClass(class{constructor(t){this.view=t,this.timeout=-1,this.set=!0;let{delay:e}=t.state.facet(h);this.lintTime=Date.now()+e,this.run=this.run.bind(this),this.timeout=setTimeout(this.run,e)}run(){let t=Date.now();if(t<this.lintTime-10)setTimeout(this.run,this.lintTime-t);else{this.set=!1;let{state:e}=this.view,{sources:o}=e.facet(h);Promise.all(o.map(i=>Promise.resolve(i(this.view)))).then(i=>{let n=i.reduce((s,r)=>s.concat(r));this.view.state.doc==e.doc&&this.view.dispatch(te(this.view.state,n))},i=>{U(this.view.state,i)})}}update(t){let e=t.state.facet(h);(t.docChanged||e!=t.startState.facet(h))&&(this.lintTime=Date.now()+e.delay,this.set||(this.set=!0,this.timeout=setTimeout(this.run,e.delay)))}force(){this.set&&(this.lintTime=Date.now(),this.run())}destroy(){clearTimeout(this.timeout)}}),h=E.define({combine(t){return Object.assign({sources:t.map(e=>e.source)},B(t.map(e=>e.config),{delay:750,markerFilter:null,tooltipFilter:null}))},enables:N});function be(t,e={}){return h.of({source:t,config:e})}function we(t){let e=t.plugin(N);e&&e.force()}function V(t){let e=[];if(t)e:for(let{name:o}of t){for(let i=0;i<o.length;i++){let n=o[i];if(/[a-zA-Z]/.test(n)&&!e.some(s=>s.toLowerCase()==n.toLowerCase())){e.push(n);continue e}}e.push("")}return e}function _(t,e,o){var i;let n=o?V(e.actions):[];return u("li",{class:"cm-diagnostic cm-diagnostic-"+e.severity},u("span",{class:"cm-diagnosticText"},e.renderMessage?e.renderMessage():e.message),(i=e.actions)===null||i===void 0?void 0:i.map((s,r)=>{let l=p=>{p.preventDefault();let S=b(t.state.field(d).diagnostics,e);S&&s.apply(t,S.from,S.to)},{name:a}=s,c=n[r]?a.indexOf(n[r]):-1,f=c<0?a:[a.slice(0,c),u("u",a.slice(c,c+1)),a.slice(c+1)];return u("button",{type:"button",class:"cm-diagnosticAction",onclick:l,onmousedown:l,"aria-label":` Action: ${a}${c<0?"":` (access key "${n[r]})"`}.`},f)}),e.source&&u("div",{class:"cm-diagnosticSource"},e.source))}var A=class extends W{constructor(e){super(),this.diagnostic=e}eq(e){return e.diagnostic==this.diagnostic}toDOM(){return u("span",{class:"cm-lintPoint cm-lintPoint-"+this.diagnostic.severity})}},y=class{constructor(e,o){this.diagnostic=o,this.id="item_"+Math.floor(Math.random()*4294967295).toString(16),this.dom=_(e,o,!0),this.dom.id=this.id,this.dom.setAttribute("role","option")}},w=class{constructor(e){this.view=e,this.items=[];let o=n=>{if(n.keyCode==27)I(this.view),this.view.focus();else if(n.keyCode==38||n.keyCode==33)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(n.keyCode==40||n.keyCode==34)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(n.keyCode==36)this.moveSelection(0);else if(n.keyCode==35)this.moveSelection(this.items.length-1);else if(n.keyCode==13)this.view.focus();else if(n.keyCode>=65&&n.keyCode<=90&&this.selectedIndex>=0){let{diagnostic:s}=this.items[this.selectedIndex],r=V(s.actions);for(let l=0;l<r.length;l++)if(r[l].toUpperCase().charCodeAt(0)==n.keyCode){let a=b(this.view.state.field(d).diagnostics,s);a&&s.actions[l].apply(e,a.from,a.to)}}else return;n.preventDefault()},i=n=>{for(let s=0;s<this.items.length;s++)this.items[s].dom.contains(n.target)&&this.moveSelection(s)};this.list=u("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:o,onclick:i}),this.dom=u("div",{class:"cm-panel-lint"},this.list,u("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>I(this.view)},"\xD7")),this.update()}get selectedIndex(){let e=this.view.state.field(d).selected;if(!e)return-1;for(let o=0;o<this.items.length;o++)if(this.items[o].diagnostic==e.diagnostic)return o;return-1}update(){let{diagnostics:e,selected:o}=this.view.state.field(d),i=0,n=!1,s=null;for(e.between(0,this.view.state.doc.length,(r,l,{spec:a})=>{let c=-1,f;for(let p=i;p<this.items.length;p++)if(this.items[p].diagnostic==a.diagnostic){c=p;break}c<0?(f=new y(this.view,a.diagnostic),this.items.splice(i,0,f),n=!0):(f=this.items[c],c>i&&(this.items.splice(i,c-i),n=!0)),o&&f.diagnostic==o.diagnostic?f.dom.hasAttribute("aria-selected")||(f.dom.setAttribute("aria-selected","true"),s=f):f.dom.hasAttribute("aria-selected")&&f.dom.removeAttribute("aria-selected"),i++});i<this.items.length&&!(this.items.length==1&&this.items[0].diagnostic.from<0);)n=!0,this.items.pop();this.items.length==0&&(this.items.push(new y(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")})),n=!0),s?(this.list.setAttribute("aria-activedescendant",s.id),this.view.requestMeasure({key:this,read:()=>({sel:s.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:r,panel:l})=>{r.top<l.top?this.list.scrollTop-=l.top-r.top:r.bottom>l.bottom&&(this.list.scrollTop+=r.bottom-l.bottom)}})):this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant"),n&&this.sync()}sync(){let e=this.list.firstChild;function o(){let i=e;e=i.nextSibling,i.remove()}for(let i of this.items)if(i.dom.parentNode==this.list){for(;e!=i.dom;)o();e=i.dom.nextSibling}else this.list.insertBefore(i.dom,e);for(;e;)o()}moveSelection(e){if(this.selectedIndex<0)return;let o=this.view.state.field(d),i=b(o.diagnostics,this.items[e].diagnostic);i&&this.view.dispatch({selection:{anchor:i.from,head:i.to},scrollIntoView:!0,effects:$.of(i)})}static open(e){return new w(e)}};function x(t,e='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${e}>${encodeURIComponent(t)}</svg>')`}function P(t){return x(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${t}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}var le=v.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:P("#d11")},".cm-lintRange-warning":{backgroundImage:P("orange")},".cm-lintRange-info":{backgroundImage:P("#999")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}}),D=class extends ee{constructor(e){super(),this.diagnostics=e,this.severity=e.reduce((o,i)=>{let n=i.severity;return n=="error"||n=="warning"&&o=="info"?n:o},"info")}toDOM(e){let o=document.createElement("div");o.className="cm-lint-marker cm-lint-marker-"+this.severity;let i=this.diagnostics,n=e.state.facet(T).tooltipFilter;return n&&(i=n(i)),i.length&&(o.onmouseover=()=>ae(e,o,i)),o}};function re(t,e){let o=i=>{let n=e.getBoundingClientRect();if(!(i.clientX>n.left-10&&i.clientX<n.right+10&&i.clientY>n.top-10&&i.clientY<n.bottom+10)){for(let s=i.target;s;s=s.parentNode)if(s.nodeType==1&&s.classList.contains("cm-tooltip-lint"))return;window.removeEventListener("mousemove",o),t.state.field(z)&&t.dispatch({effects:M.of(null)})}};window.addEventListener("mousemove",o)}function ae(t,e,o){function i(){let r=t.elementAtHeight(e.getBoundingClientRect().top+5-t.documentTop);t.coordsAtPos(r.from)&&t.dispatch({effects:M.of({pos:r.from,above:!1,create(){return{dom:H(t,o),getCoords:()=>e.getBoundingClientRect()}}})}),e.onmouseout=e.onmousemove=null,re(t,e)}let{hoverTime:n}=t.state.facet(T),s=setTimeout(i,n);e.onmouseout=()=>{clearTimeout(s),e.onmouseout=e.onmousemove=null},e.onmousemove=()=>{clearTimeout(s),s=setTimeout(i,n)}}function ce(t,e){let o=Object.create(null);for(let n of e){let s=t.lineAt(n.from);(o[s.from]||(o[s.from]=[])).push(n)}let i=[];for(let n in o)i.push(new D(o[n]).range(+n));return O.of(i,!0)}var de=X({class:"cm-gutter-lint",markers:t=>t.state.field(q)}),q=L.define({create(){return O.empty},update(t,e){t=t.map(e.changes);let o=e.state.facet(T).markerFilter;for(let i of e.effects)if(i.is(C)){let n=i.value;o&&(n=o(n||[])),t=ce(e.state.doc,n.slice(0))}return t}}),M=k.define(),z=L.define({create(){return null},update(t,e){return t&&e.docChanged&&(t=j(e,t)?null:Object.assign(Object.assign({},t),{pos:e.changes.mapPos(t.pos)})),e.effects.reduce((o,i)=>i.is(M)?i.value:o,t)},provide:t=>J.from(t)}),fe=v.baseTheme({".cm-gutter-lint":{width:"1.4em","& .cm-gutterElement":{padding:".2em"}},".cm-lint-marker":{width:"1em",height:"1em"},".cm-lint-marker-info":{content:x('<path fill="#aaf" stroke="#77e" stroke-width="6" stroke-linejoin="round" d="M5 5L35 5L35 35L5 35Z"/>')},".cm-lint-marker-warning":{content:x('<path fill="#fe8" stroke="#fd7" stroke-width="6" stroke-linejoin="round" d="M20 6L37 35L3 35Z"/>')},".cm-lint-marker-error:before":{content:x('<circle cx="20" cy="20" r="15" fill="#f87" stroke="#f43" stroke-width="6"/>')}}),T=E.define({combine(t){return B(t,{hoverTime:300,markerFilter:null,tooltipFilter:null})}});function ke(t={}){return[T.of(t),q,de,fe,z]}export{I as closeLintPanel,ge as diagnosticCount,we as forceLinting,ke as lintGutter,pe as lintKeymap,be as linter,se as nextDiagnostic,ne as openLintPanel,te as setDiagnostics,C as setDiagnosticsEffect};
//# sourceMappingURL=lint.mjs.map